---
title: "htmlwidgets with reactR"
author: "Alan Dipert"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{htmlwidgets with reactR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction to htmlwidgets with reactR

The [htmlwidgets](https://www.htmlwidgets.org) package provides a framework for creating R bindings to JavaScript libraries. reactR adds to this framework by simplifying the creation of widgets that build on [React](https://facebook.github.io/react/)-based libraries or code.

In particular, reactR adds:

* The `reactR::scaffoldReactWidget` function for generating a skeletal React-based htmlwidget, including JavaScript build tool configuration. It is analagous to `htmlwidgets::scaffoldWidget`.
* An [htmlDependency](https://shiny.rstudio.com/articles/packaging-javascript.html), returned by `reactR::html_dependency_reacttools`, that adds `window.reactR` to the browser environment. Scaffolded widgets include a reference to this htmlDependency, as well as one to `reactR::html_dependency_react` which provides React itself.
* The `window.reactR.reactWidget` JavaScript function, which creates an installs a named widget backed by a set of [React Components](https://reactjs.org/docs/react-component.html).
* `reactR::reactMarkup`, which prepares an `htmltools::tag` or `reactR::component` to be sent to the browser and rendered by React.

## Tutorial: Adapting a JavaScript library

In the following tutorial, we will build a widget around the [react-sparklines](https://reactjs.org/docs/react-component.html) React-based JavaScript library.

We'll start by preparing our machine for React and reactR widget development. Then, we'll scaffold an initial `reactSparklines` widget package. Then, we'll add functionality that will make the widget easier to use.

## Prepare your machine

In order to develop a reactR widget, you'll need to install R and optionally RStudio. If you're on Windows, you should also install [Rtools](https://cran.r-project.org/bin/windows/Rtools/).

> For an excellent general introduction to R package concepts, check out the [R packages](http://r-pkgs.had.co.nz/) online book.

In addition, you'll need to install the following JavaScript tools on your machine:

* [Node.js](https://nodejs.org): JavaScript engine and runtime for development outside of browsers. Provides the `node` and `npm` commands.
* [Yarn](https://yarnpkg.com/en/): Command-line dependency management tool, provides the `yarn` command.

## Install dependencies

Several packages must be installed to continue. You can install them like this:

> QA Note: The necessary version of reactR is not yet available on CRAN. Please install reactR with `devtools::install_github("react-R/reactR@enhancements")`

```{r eval = FALSE}
install.packages(c("shiny", "devtools", "usethis", "htmlwidgets", "reactR"))
```

## Scaffolding

To create a new widget you can call `scaffoldReactWidget` to generate the basic structure and build configuration. This function will:

* Create the .R, .js, .yaml, and .json files required by your widget;
* If provided, take an [npm]() package name and version as a two-element character vector. For example, the npm package `foo` at version `^1.2.0` would be expressed as `c("foo", "^1.2.0")`. The package, if provided, will be added to the new widget's `package.json` as a build dependency.

The following R code will create a package and add the `react-sparklines` dependency:

```{r eval = FALSE}
# Create a directory 'reactSparklines' and populate it with skeletal package
# If run within RStudio, this will create a new RStudio session
usethis::create_package("reactSparklines")
# Set the current working directory to the one that was created unless a new
# RStudio session has been launched.
setwd("reactSparklines")
# Generate skeletal reactR widget code and supporting build configuration
reactR::scaffoldReactWidget("reactSparklines", c("react-sparklines", "^1.7.0"))
```

At this point, the `reactSparklines` contains a bare-bones widget in a package called `reactSparklines`.

## Building and installing

### Building the JavaScript

The next step is to navigate to the `reactSparklines` directory in your terminal. Then, run the following commands:

```{shell}
yarn install
yarn run webpack --mode=development
```

* `yarn install` downloads all of the dependencies listed in `package.json` and creates a new file, `yarn.lock`. You should add this file to revision control. It will be updated whenever you change dependencies and run `yarn install`. **You only need to run it after modifying package.json**.
* `yarn run webpack --mode=development` converts the [ES2015](https://babeljs.io/docs/en/learn/) JavaScript source file at `srcjs/reactSparklines.js` into `inst/htmlwidgets/reactSparklines.js`. The difference between the two is that the one in `inst/` bundles all dependencies. It is also compiled in a dialect of JavaScript that will run on a wider variety of old browsers.

For further documentation on `yarn install`, see the [yarn documentation](https://yarnpkg.com/lang/en/docs/cli/install/).

`yarn run webpack` is not strictly a `yarn` command. In fact, `yarn run` simply delegates to the [webpack](https://webpack.js.org/) program. `development` is one of several [webpack modes](https://webpack.js.org/concepts/#mode). webpack's configuration is generated by `scaffoldReactWidget` in the file `webpack.config.js`.

### Building the package

While the JavaScript has been built, the `reactSparklines` package has not. Now that the JavaScript asset has been created, we can build it:

```{r eval = FALSE}
devtools::document()
devtools::install(quick = TRUE)
```

Alternatively, in RStudio, you can use the keyboard shortcuts `Ctrl+Shift+D` and `Ctrl-Shift-B` to document and build the package. (On macOS, the shortcuts are `Cmd+Shift+D` and `Cmd+Shift+B`)

## Run example

Now that the widget's JavaScript has been compiled and the package has been installed, we can run `app.R` to see the widget in action:

```{r eval = FALSE}
shiny::runApp()
```

Alternatively, in RStudio, you can open `app.R` and press `Ctrl-Shift-Enter` (`Cmd-Shift-Enter` on macOS). You should see something like the following appear in the Viewer pane:

```{r echo=FALSE}
knitr::include_graphics('./widget_app.jpg')
```

## Implement Functionality

At this point, we've scaffolded a widget and built its JavaScript, but we have not implemented any functionality provided by the `react-sparklines` library.

To expose that functionality through our widget, we must modify the JavaScript in `srcjs/reactSparklines.js`. After scaffolding, it looks like this:

```{js eval=FALSE}
import { reactWidget } from 'reactR';

reactWidget('reactSparklines', 'output', {});
```
